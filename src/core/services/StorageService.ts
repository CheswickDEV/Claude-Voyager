import browser from "webextension-polyfill";import type { AppSettings, StorageKey, StorageSchema } from "../types/storage";import { LoggerService } from "./LoggerService";const SCHEMA_VERSION_KEY = "__schema_version";const CURRENT_SCHEMA_VERSION = 1;const defaultSettings: AppSettings = {  locale: "de",  features: {    timelineEnabled: true,    foldersEnabled: true,    promptsEnabled: true,    exportEnabled: true  }};const defaultStorage: StorageSchema = {  settings: defaultSettings};export class StorageService {  private static instance: StorageService | null = null;  private logger = LoggerService.getInstance();  /**   * Returns the singleton instance.   */  static getInstance(): StorageService {    if (!StorageService.instance) {      StorageService.instance = new StorageService();    }    return StorageService.instance;  }  /**   * Initializes storage, including migrations and defaults.   */  async initialize(): Promise<void> {    const { [SCHEMA_VERSION_KEY]: version } = await browser.storage.local.get(      SCHEMA_VERSION_KEY    );    const storedVersion = typeof version === "number" ? version : 0;    if (storedVersion < CURRENT_SCHEMA_VERSION) {      await this.runMigrations(storedVersion);      await browser.storage.local.set({ [SCHEMA_VERSION_KEY]: CURRENT_SCHEMA_VERSION });    }    await this.ensureDefaults();  }  /**   * Reads a key from local storage.   */  async get<K extends StorageKey>(key: K): Promise<StorageSchema[K]> {    const stored = await browser.storage.local.get(key);    const value = stored[key];    if (value === undefined) {      return defaultStorage[key];    }    return value as StorageSchema[K];  }  /**   * Writes a key to local storage.   */  async set<K extends StorageKey>(key: K, value: StorageSchema[K]): Promise<void> {    await browser.storage.local.set({ [key]: value });  }  /**   * Reads a key from sync storage.   */  async getSync<K extends StorageKey>(key: K): Promise<StorageSchema[K]> {    const stored = await browser.storage.sync.get(key);    const value = stored[key];    if (value === undefined) {      return defaultStorage[key];    }    return value as StorageSchema[K];  }  /**   * Writes a key to sync storage.   */  async setSync<K extends StorageKey>(key: K, value: StorageSchema[K]): Promise<void> {    await browser.storage.sync.set({ [key]: value });  }  private async ensureDefaults(): Promise<void> {    const stored = await browser.storage.local.get(Object.keys(defaultStorage));    const updates: Partial<StorageSchema> = {};    (Object.keys(defaultStorage) as StorageKey[]).forEach((key) => {      if (stored[key] === undefined) {        updates[key] = defaultStorage[key];      }    });    if (Object.keys(updates).length > 0) {      await browser.storage.local.set(updates);    }  }  private async runMigrations(fromVersion: number): Promise<void> {    if (fromVersion < 1) {      await browser.storage.local.set(defaultStorage);      this.logger.info("Initialized storage defaults", { fromVersion });    }  }}